# 数据库技术基础

## 概述

数据：是数据库中存储的基本对象，是描述事物的符号记录。

数据的种类：文本、图形、图像、音频、视频。（一切信息化的东西都是数据）

数据库DB：长期存储在计算机内、有组织的、可共享的大量数据的集合

数据库的基本特征：数据按一定的数据模型组织（现在主流的数据库都是关系模型，有行有列有表）、描述和存储；可为各种用户共享；冗余度较小；数据独立性较高；易扩展

数据库系统DB：是一个采用了数据库技术，有组织地、动态地存储大量相关数据，方便多用户访问的**计算机系统**。其由下面四个部分组成：数据库（统一管理、长期存储在计算机内的，有组织的相关数据的集合）、硬件（构成计算机系统包括存储数据所需的外部设备）、软件（操作系统、**数据库管理系统**及应用程序）、人员（系统分析和数据库设计人员、应用程序员、最终用户、数据库管理员DBA）。

**数据库管理系统**DBMS（属于数据库系统的软件）的功能：实现对共享数据有效的组织、管理和存取。包括数据定义、数据库操作、数据库运行管理、数据的存储管理、数据库的建立和维护等。

## 三级模式-两级映像

内模式：管理如何存储**物理的数据**，对应具体**物理存储文件**

模式：又称为概念模式，就是我们通常使用的**基本表**，根据应用、需求将物理数据划分成一张张表。

外模式：对应数据库中的**视图**这个级别，将表进行一定的处理后再提供给用户使用

外模式-模式映像（保证数据的**逻辑独立性**）：是表和视图之间的映射，存在于概念级和外部级之间，若表中数据发生了修改，只需要修改此映射，而无需修改应用程序。

模式-内模式映像（保证了数据的**物理独立性**）：是表和数据的物理存储之间的映射存在于概念级和内部级之间，若修改了数据存储方式，只需要修改此映射，而不需要去修改应用程序。

> 映像目的：为了数据库中数据改变的时候，应用程序无需改变

![三级模式](./imgs/4.1-三级模式.jpg)

## 数据库设计

🔺 流程、干什么了、产出

需求分析：即分析数据存储的要求，**产出物有数据流图数据字典、需求说明书**。

概念结构设计：就是**设计E-R图**，也即实体-联系图，与物理实现无关，说明有哪些实体，实体有哪些属性。

逻辑结构设计：**将E-R图，转换成关系模式**，也即转换成实际的表和表中的列属性，这里要考虑很多**规范化**的东西。

物理设计：根据生成的表等概念，**生成物理数据库**。 

![数据库设计](./imgs/4.1-数据库设计.png)

## 数据模型

- **关系模型是二维表的形式表示的实体-联系模型**，是将实体-联系模型转换而来的，经过开发人员设计的；

- **概念模型是从用户的角度进行建模**的（ER图），是现实世界到信息世界的第一抽象是真正的实体-联系模型。

- 网状模型表示实体类型及其实体之间的联系，一个事物和另外几个都有联系形成一张网。

- 面向对象模型是采用面向对象的方法设计数据库，以对象为单位，每个对象包括属性和方法，具有类和继承等特点。

🔺数据模型三要素：**数据结构**（所研究的对象类型的集合）、**数据操作**（增删改查，对数据库中各种对象的实例允许执行的操作的集合）、**数据的约束条件**（一组完整性规则的集合，年龄 < 150 之类的）。

### 🔺E-R 图

用E-R图来描述概念数据模型，世界是由一组称作实体的基本对象和这些对象之间的联系构成的。

在E-R模型中，使用**椭圆表示属性**（一般没有）、**长方形表示实体**、**菱形表示联系**，**联系的两端要填写联系类型**，示例如下图：

![ER图](./imgs/4.1-ER图.jpg)

实体：**客观存在并可相互区别的事物**。可以是具体的人、事、物或抽象概念如人、汽车、图书、账户、贷款。

弱实体和强实体：弱实体依赖于强实体的存在而存在（通过上图圆圈连接，“经理”、“部门经理”就是弱实体）

实体集：具有相同类型和共享相同属性的实体的集合，如学生、课程

属性：**实体所具有的特性**

属性分类：简单属性和复合属性（由多个简单属性组成的，e.g.家庭住址：国家+省份+市+街道...）；单值属性和多值属性；NULL属性；派生属性（可由其他属性计算得来）

域：属性的取值范围称为该属性的域

码（key）：唯一标识实体的属性集（键）。

联系：现实世界中**事物内部以及事物之间的联系**，在E-R图中反映为**实体内部的联系和实体之间的联系**。

联系类型：**一对一`1:1`、一对多`1:N`、多对多`M:N`**。

### 数据模型

关系模型中数据的逻辑结构是**二维表**，由行列组成。用表格结构表达实体集，用外键标识实体间的联系。

**元组（Tuple）**：在关系模型中，元组是表中的一行。

**属性（Attribute）**：元组中的一个分量，类似于表中的一列。

![关系模型](./imgs/4.1-关系模型.png)

优点：建立在严格的数学概念基础上;概念单一、结构简单、清晰，用户易懂易用；存取路径对用户透明，从而数据独立性、安全性好，简化数据库开发工作。

缺点：由于存取路径透明，查询效率往往不如非关系数据模型

#### 🔺ER 模型转换为关系模型

**每个实体都对应一个关系模式**（强实体）；联系分为三种：

- `1:1`联系中，联系可以**放到任意的两端实体中，作为一个属性**（要保证`1:1`的两端关联），也可以转换为一个单独的关系模式；
- `1:N`的联系中，联系可以单独作为一个关系模式，也可以**在N端中加入1端实体的主键**
- `M:N`的联系中，联系**必须作为一个单独的关系模式，其主键是M和N端的联合主键**。

## 关系代数

- 并：结果是两张表中所有记录数合并，相同记录只显示一次（不会重复显示 c.f. 笛卡尔积）
- 交：结果是两张表中相同的记录
- 差：R-S，结果是 R 表中有而 S 表中没有的那些记录

![关系代数](./imgs/4.2-关系代数.png)

- 笛卡尔积：`S1*S2`，产生的结果包括 S1 和 S2 的所有属性列，并且 S1 中每条记录依次和 S2 中所有记录组合成一条记录，最终属性列为`S1+S2`属性列，记录数为`S1*S2`记录数。（会重复显示）

  ![笛卡尔积](./imgs/4.2-笛卡尔积.png)

- 投影：实际是按条件选择某关系模式中的**某列**，列也可以用数字表示。（select *）

- 选择：实际是按条件选择某关系模式中的**某条**记录。（where xxx）

  ![投影选择](./imgs/4.2-投影选择.png)

- 自然连接的结果**显示全部的属性列**，但是**相同属性列只显示一次**，显示两个关系模式中**属性相同（A C）且值相同（A C 的值）**的记录。

  ![自然连接](./imgs/4.2-自然连接.png)

🔺例：

![关系代数例题](./imgs/4.2-关系代数例题.jpg)

### 函数依赖

给定一个 X，能唯一确定一个 Y，就称 X 确定 Y，或者说依赖于 X，例如`Y=X*X`函数。
函数依赖又可扩展以下两种规则：

- 部分函数依赖：A可确定C，(A,B)也可确定C，(A,B)中的一部分(即A)可以确定C，称为部分函数依赖。
- 传递函数依赖：当A和B不等价时，A可确定B，B可确定C，则A可确定C，是传递函数依赖；若A和B等价，则不存在传递，直接就可确定C。

> A-->B = A 决定 B = B 依赖于 A

![函数依赖](./imgs/4.2-函数依赖.png)

#### 函数依赖的公理系统(Armstrong)

设关系模式 R<U，F>，U 是关系模式 R 的属性全集，F 是关系模式 R 的一个函数依赖集。对于R<U，F> 来说有以下的：

![函数依赖公理](./imgs/4.2-函数依赖公理.png)

#### 键与约束

超键：能**唯一标识**此表的属性的组合。（只要求唯一标识：学号、学号+姓名、学号+年级...都是超键，可以有冗余属性）

候选键：超键中**去掉冗余的属性**，剩余的属性就是候选键。（学号）

主键：**任选一个候选键**，即可作为主键。

外键：**其他表中的主键**。

主属性：**候选键内的属性为主属性**，其他属性为非主属性。

实体完整性约束：即**主键约束，主键值不能为空，也不能重复**。

参照完整性约束：即外键约束，**外键必须是其他表中已经存在的主键的值，或者为空**。

用户自定义完整性约束：**自定义表达式约束**，如设定年龄属性的值必须在0到150之间。

## 🔺范式

### 第一范式 `1NF`

关系中的**每一个分量必须是一个不可分的数据项**。通俗地说，第一范式就是表中不允许有小表的存在。

以下表不算第一范式：（薪资表有复合属性）

![不是1NF](./imgs/4.2-不是1NF.png)

### 第二范式 `2NF`

如果**关系R属于1NF**，且**每一个非主属性完全函数依赖于任何一个候选码**，则R属于2NF。

通俗地说，2NF就是在1NF的基础上，表中的**每一个非主属性不会依赖复合主键中的某一个列**。（**部分**函数依赖只存在于联合主键中，对于单属性的主键来讲，必然是第二范式）

按照定义，上面的学生表就不满足2NF，因为学号不能完全确定课程号和成绩（每个学生可以选多门课）。

### 第三范式 `3NF`

在满足1NF的基础上，表中不存在非主属性对码的传递依赖。

继续上面的实例，学生关系模式就不属于3NF，因为学生无法直接决定系主任和系名，是由学号->系编号，再由系编号->系主任，系编号->系名，因此存在非主属性对主属性的传递依赖，

#### 实例：

用一个单一的关系模式学生来描述学校的教务系统：学生(学号,学生姓名,系号,系主任姓名,课程号,成绩)

![三范式](./imgs/4.2-三范式.jpg)

### BC范式BCNF

指**在第三范式的基础上进一步消除主属性对于码的部分函数依赖和传递依赖**。

通俗的来说，就是**在每一种情况下，每一个依赖的左边决定因素都必然包含候选键**。

![BC范式](./imgs/4.2-BC范式.png)

上图中，候选键有两种情况：组合键 (S,T) 或者 (SJ)，依赖集为 {SJ-T，T-J}，可知，STJ 三个属性都是主属性，因此其达到了3NF（无非主属性），然而，第二种情况，即 **(S,J) 为候选键**的时候，对于依赖 **T->J，T 在这种情况不是候选键**，即 T-J 的决定因素不包含任意候选码，因此上图不是 BCNF。

要使上图关系模式转换为BCNF也很简单，只需要**将依赖T->J变为TS->J**，即可这样其左边决定因素就包含了候选键之一S。



🔺例：

> 🔺候选码能唯一标识整个属性，通过候选码能把所有属性都推导出来
>
> 1. 凡是从未在右边出现过的属性，必然是候选码之一
> 2. 以该属性为基础，依次扩展，看能否遍历所有属性

> 🔺只要是候选关键字中的属性，都是主属性

![范式例题](./imgs/4.2-范式例题.jpg)





