# 计算机系统知识

（补：硬件组成，CPU，编码，浮点数）





## 指令系统

#### 计算机指令的组成

一条指令由**操作码**和**操作数**两部分组成  --> **操作码 | 地址码**

操作码决定要完成的操作，操作数指参加运算的数据及其所在的单元地址。

在计算机中，操作要求和操作数地址都由二进制数码表示，分别称作操作码和地址码，整条指令以二进制编码的形式存放在存储器中。

#### 计算机指令执行过程

取指令 -- 分析指令 -- 执行指令

1. 将程序计数器PC（存储下一条指令的执行地址）中的指令地址取出，送入地址总线
2. CPU依据指令地址去内存中取出指令内容存入指令寄存器IR（暂存指令）
3. 由指令译码器ID（对指令进行分析）进行分析，分析指令操作码
4. 执行指令，取出指令执行所需的源操作数

#### 指令寻址方式

- 顺序寻址方式

当执行一段程序时，是一条指令接着一条指令地顺序执行 （地址都在程序计数器 PC 中）

- 跳跃寻址方式

指下一条指令的地址码**不是由程序计数器给出，而是由本条指令直接给出**。程序跳跃后，按新的指令地址开始顺序执行。因此，程序计数器的内容也必须相应改变，以便及时跟踪新的指令地址。

#### 指令操作数的寻址方式

- 立即寻址方式：指令的**地址码字段指出的不是地址，而是操作数本身**

​	操作码 | 操作数本身

- 直接寻址方式：在指令的地址字段中直接指出**操作数在主存中的地址** （比较规矩）

  操作码 | 操作数地址（地址码）

- 间接寻址方式：指令地址码字段所指向的**存储单元中存储的是操作数的地址**

  操作码 | 存储操作数地址的地址（找两次，访问两次主存）

- 寄存器寻址方式：指令中的地址码是**寄存器的编号** （操作数存在寄存器里）

- 基址寻址方式：将基址寄存器的内容加上指令中的形式地址而形成操作数的有效地址，其优点是可以扩大寻址能力

- 变址寻址方式：变址寻址方式计算有效地址的方法与基址寻址方式很相似，它是将变址寄存器的内容加上指令中的形式地址而形成操作数的有效地址。

#### 指令系统类型

CISC (complex) 复杂指令系统，兼容性强，指令繁多、长度可变，由微程序实现

RISC (reduced) 精简指令系统，指令少，使用频率接近，主要依靠硬件实现（通用寄存器、硬布线逻辑控制）

|              |                                                              |            |                                                              |                            |
| ------------ | ------------------------------------------------------------ | ---------- | ------------------------------------------------------------ | -------------------------- |
| 指令系统类型 | 指令                                                         | 寻址方式   | 实现方式                                                     | 其它                       |
| CISC         | 数量多，使用频率差别大，可变长格式                           | 支持多种   | **微程序控制技术（微码）**                                   | 研制周期长                 |
| RISC         | 数量少，使用频率接近定长格式，大部分为单周期指令，操作寄存器，只有Load/Store操作内存 | 支持方式少 | 增加了**通用寄存器**；硬布线**逻辑控制为主**；适合采用**流水线** | 优化编译，有效支持高级语言 |

#### 流水线 （RISC 中才用）

![流水线示意图](./imgs/2.2-流水线.jpg)



##### 流水线时间计算

- 流水线周期：指令分成不同执行段，其中执行时间最长的段为流水线周期。

- 时间公式：1条指令执行时间+(指令条数-1)*流水线周期

- 流水线吞吐率：单位时间内执行的指令条数

​	公式：指令条数/流水线执行时间

- 流水线的加速比：加速比即使用流水线后的效率提升度，即比不使用流水线快了多少倍，越高表明流水线效率越高

​	公式：不使用流水线执行时间/使用流水线执行时间

例：

![流水线示意图](./imgs/2.2-流水线例题.jpg)

## 存储系统

![流水线示意图](./imgs/2.3-存储系统.jpg)

上-下：速度快-慢，容量小-大



计算机采用分级存储体系的主要目的是为了**解决存储容量、成本和速度之间的矛盾问题**

两级存储：cache-主存、主存-辅存（虚拟存储体系）

局部性原理：在CPU运行时，所访问的数据会趋向于一个较小的局部空间地址内（怎么知道哪些数据需要放在 cache 里）

- 时间局部性原理：如果一个数据项正在被访问，那么在近期它很可能会被再次访问，即在相邻的时间里会访问同一个数据项。
- 空间局部性原理：在最近的将来会用到的数据的地址和现在正在访问的数据地址很可能是相近的，即相邻的空间地址会被连续访问。

### Cache

Cache由**控制部分**和**存储器**组成，存储器存储数据，控制部分判断CPU要访问的数据是否在Cache中，在则命中，不在则依据一定的算法从主存中替换。

#### 地址映射

在CPU工作时，**送出的是主存单元的地址**，而**应从Cache存储器中读/写信息**。这就需要**将主存地址转换为Cache存储器地址**，这种地址的转换称为地址映像，**由硬件（!!!!!）自动完成映射**，分为下列三种方法：

- 直接映射：Cache 和 主存两者块号相同才能命中（无所谓区号）（冲突大）

- 全相联映射：主存中任意一块都与Cache中任意一块对应，因此可以随意调入Cache任意位置

  缺点：地址变换复杂，速度较慢

  优点：不容易发生冲突（主存可以随意调入Cache任意块，只有当Cache满了才会发生块冲突）

- 组组相连映像：自前面两种方式的结合，组间采用直接映像，即主存中组号与Cache中组号相同的组才能命中，但是组内全相联映像，也即组号相同的两个组内的所有块可以任意调换。

#### 替换算法

替换（Cache满了的时候）算法的目标就是使Cache 获得尽可能高的命中率。

- 随机替换算法：用随机数发生器产生一个要替换的块号，将该块替换出去

- 先进先出算法：将最先进入Cache的信息块替换出去
- 近期最少使用算法：将近期最少使用的Cache 中的信息块替换出去
- 优化替换算法：先执行一次程序，统计Cache的替换情况；有了这样的先验信息，在第二次执行该程序时便可以用最有效的方式来替换

#### 命中率及平均时间

命中率：当CPU所访问的数据在cache中时，命中，直接从Cache中读取数据

设读取一次Cache时间为1ns，若CPU访问的数据不在Cache中则需要从内存中读取，设读取一次内存的时间为 1000ns，若在CPU多次读取数据过程中，有90%命中Cache，则CPU读取一次的平均时间为`(90%*1+10%*1000)`ns

Cache 容量与命中率的关系↓：容量越大，命中率越高

![流水线示意图](./imgs/2.3-命中率.png)

### 存储系统

 基本概念：K, M, G 是数量但我，在存储器里相差 1024 (2^10) 倍，b, B 是存储单位，1B = 8b

![流水线示意图](./imgs/2.3-存储系统例题.jpg)